<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <link rel="stylesheet" th:href="@{/css/reset.css}">
    <link rel="stylesheet" th:href="@{/css/calendar/myCalendar.css}">

    <title>Document</title>


</head>
<body>

<div th:replace="~{include/header :: headerFragment}"></div>

    <div id="mobileCalendarButton" >
        <div>
            <button type="button" id="mobileOpenJobPosting">ê³µì±„ì •ë³´</button>
            <button type="button" id="mobileJobPosting">ì±„ìš©ì •ë³´</button>
            <button type="button" id="mobileStartDate">ì‹œì‘ì¼</button>
            <button type="button" id="mobileEndDate">ì¢…ë£Œì¼</button>
        </div>
    </div>

    <div id='external-events'>

    </div>


    <div id="titleToolTip"></div>
    <div id="explanationToolTip" style="display: block; position:absolute; border:none; padding: 10px; z-index:10000;
                                        left: 1400px">
        <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; background-color: green"></span>
        <span style="display: inline-block">: ê³µê³  ì‹œì‘ì¼</span>
        <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; margin-left: 10px; background-color: red"></span>
        <span style="display: inline-block">: ê³µê³  ì¢…ë£Œì¼</span>
    </div>
    <div id='calendar'></div>



    <script th:src="@{/css/js/calendar.js}"></script>
    <script>

    document.addEventListener('DOMContentLoaded', function() {

    var Calendar = FullCalendar.Calendar;
    var Draggable = FullCalendar.Draggable;

    var containerEl = document.getElementById('external-events');
    var calendarEl = document.getElementById('calendar');
    var tooltip = document.getElementById('titleToolTip');

        if (tooltip && tooltip.parentNode !== document.body) {
            document.body.appendChild(tooltip);
        }

    var currentEventMode = null;

    // initialize the external events
    // -----------------------------------------------------------------

    new Draggable(containerEl, {
        itemSelector: '.fc-event',
        eventData: function(eventEl) {
        return {
            title: eventEl.innerText
        };
        }
    });

    // function initializeCalendar(events) {
        var customButtons = {
            startDay: {
                text: 'ì‹œì‘ì¼',
                className: 'startDay',
                click: function () {
                    ButtonClick('startDay');

                }
            },
            endDay: {
                text: 'ì¢…ë£Œì¼',
                className: 'endDay',
                click: function () {
                    ButtonClick('endDay');
                }
            },

            allPosting: {
                text: 'ì „ì²´',
                className: 'allPosting',
                click: function () {
                    ButtonClick('allPosting');
                }
            },
            allCalendar: {
                text: 'ì „ì²´ë‹¬ë ¥',
                className: 'allCalendar',
                click: function () {
                    // ì„¸ì…˜ì— í•„ìš”í•œ ë°ì´í„° ì €ì¥ (ì˜ˆ: 'calendar'ë¼ëŠ” í‚¤ì— 'true' ê°’ ì €ì¥)
                    // sessionStorage.setItem('myCalendarAccess', 'true');

                    // í˜ì´ì§€ ì´ë™ (ì˜ˆ: 'calendar.html'ë¡œ ì´ë™)
                    location.href = "/calendar/calendar";  // ì›í•˜ëŠ” í˜ì´ì§€ë¡œ ë³€ê²½ //mycalendar í˜ì´ì§€ë¡œ ì´ë™
                }
            }
        };

        function ButtonClick(e) {

            currentEventMode = e; //í˜„ì¬ ëª¨ë“œ ì €ë‹¹

            var buttonClasses = ['fc-startDay-button', 'fc-endDay-button', 'fc-allCalendar-button'];

            for (var i = 0; i < buttonClasses.length; i++) {
                var btn = document.querySelector('.' + buttonClasses[i]);
                if (btn) {
                    if (buttonClasses[i] === 'fc-' + e + '-button') {
                        btn.classList.add('bottomline');
                    } else {
                        btn.classList.remove('bottomline');
                    }
                }
            }

            if(e === 'startDay') {
                calendar.removeAllEventSources();
                calendar.addEventSource({ url: '/mycalendar/eventsStartDay', method: 'GET' });

            } else if(e === 'endDay') {
                calendar.removeAllEventSources();
                calendar.addEventSource({ url: '/mycalendar/eventsEndDay', method: 'GET' });

            } else if(e === 'allPosting') {
                calendar.removeAllEventSources();
                calendar.addEventSource({ url: '/mycalendar/favoriteList', method: 'GET' });
                // calendar.addEventSource({ url: '/mycalendar/eventsEndDay', method: 'GET' });

                // calendar.setOption('events', '/mycalendar/favoriteList')


            } else {

                    calendar.setOption('events', []);
                }
        }




        var calendar = new Calendar(calendarEl, {
            locale: 'ko',
            headerToolbar: {
                left: window.innerWidth < 767 ? '' : 'allPosting,startDay,endDay',
                center: 'prev,title,next',
                right: 'allCalendar'
            },
            initialView: 'dayGridMonth',
            customButtons: customButtons,
            dayCellContent: function (arg) {
                return arg.date.getDate();
            },

            events: [], //ì´ˆê¸°ì—” ì•„ë¬´ê²ƒë„ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ



            dayMaxEvents: true, // ë˜ëŠ” ìˆ«ìë¡œ: dayMaxEvents: 3 //ì¹¸ ì´ìƒì€ + ì²˜ë¦¬

            //ì¼ì • ìŠ¤íƒ€ì¼
            eventDidMount: function (info) {
                // var mainEl = info.el.querySelector('.fc-event-main');
                // if (mainEl) {
                //     mainEl.setAttribute('title', info.event.title);
                //     mainEl.style.color = '#000'
                //     mainEl.style.backgroundColor = '#fff';
                //     mainEl.style.marginTop = '3px';
                //     mainEl.style.border = 'none';
                //
                //     //í•˜ë‚˜ì§œë¦¬ í˜•íƒœ/ì•ì— ì 
                //     // mainEl.classList.add('fc-daygrid-event-dot');
                //     mainEl.classList.add('fc-event-title');
                //
                //     //ì¦ì°¾ê³¼ ì œëª© í•œì¤„ì •ë ¬
                //     mainEl.style.display = 'flex';
                //     mainEl.style.alignItems = 'center';
                //     mainEl.style.justifyContent = 'space-between';
                //
                //     //ì‹œì‘ì¼, ì¢…ë£Œì¼ êµ¬ë¶„ì„ ìœ„í•œ colordot
                //     var colorDot = document.createElement('span');
                //     colorDot.style.display = 'inline-block';
                //     colorDot.style.width = '8px';
                //     colorDot.style.height = '8px';
                //     colorDot.style.borderRadius = '50%';
                //     colorDot.style.marginRight = '5px';
                //
                //     //ìƒ‰ê¹”êµ¬ë¶„
                //     if(info.event.source && info.event.source.url === '/mycalendar/eventsStartDay') {
                //         // || info.event.source && info.event.source.url === '/calendar/getStartDayEventsOnlyY'
                //         // || info.event.source && info.event.source.url === '/calendar/getStartDayEventsOnlyN') {
                //         colorDot.style.backgroundColor = 'green';
                //     } else if(info.event.source && info.event.source.url === '/mycalendar/eventsEndDay') {
                //         // || info.event.source && info.event.source.url === '/calendar/getEndDayEventsOnlyY'
                //         // || info.event.source && info.event.source.url === '/calendar/getEndDayEventsOnlyN') {
                //         colorDot.style.backgroundColor = 'red';
                //     }
                //
                //
                //     //ê·¸ëƒ¥ í•˜ë©´ ì•ˆë˜ë‹ˆê¹Œ ì œëª© ë¶€ë¶„ì„ spanìœ¼ë¡œ ê°ì‹¸ì„œ between ë¨¹ê²Œ
                //     var titleSpan = document.createElement('span');
                //     titleSpan.textContent = info.event.title;
                //     titleSpan.style.flex = '1';
                //     titleSpan.style.overflow = 'hidden';
                //     titleSpan.style.textOverflow = 'ellipsis';
                //     titleSpan.style.whiteSpace = 'nowrap';
                //     titleSpan.classList.add('titleSpan');
                //
                //     //í…ìŠ¤íŠ¸ ì§‘ì–´ë„£ê¸°
                //     mainEl.innerHTML = '';
                //     mainEl.appendChild(colorDot);
                //     mainEl.appendChild(titleSpan);
                //
                //
                //     titleSpan.addEventListener('mouseenter', function () {
                //
                //         var rect = titleSpan.getBoundingClientRect();
                //
                //         tooltip.innerHTML = info.event.title;
                //         tooltip.style.position = 'absolute';
                //         tooltip.style.zIndex = '9999';
                //         tooltip.style.top = (rect.top + window.scrollY - 150) + 'px';
                //         tooltip.style.left = (rect.left + window.scrollX) + 'px';
                //         tooltip.style.minWidth = rect.width + 'px';
                //         tooltip.style.backgroundColor = '#e4e4e4';
                //         tooltip.style.color = '#000';
                //
                //         tooltip.style.display = 'block';
                //
                //         titleSpan.style.cursor = 'pointer'
                //
                //
                //     });
                //
                //     titleSpan.addEventListener('mouseleave', function () {
                //         tooltip.style.display = 'none';
                //
                //         info.el.style.cursor = 'default';
                //     });
                //
                //     titleSpan.addEventListener('click', function () {
                //         var homepgDetail = info.event.extendedProps.empWantedHomepgDetail;
                //
                //         if (homepgDetail) {
                //             window.location.href = homepgDetail;
                //         } else {
                //             alert('í˜„ì¬ í•´ë‹¹ ê³µê³ ì˜ ìƒì„¸í˜ì´ì§€ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                //         }
                //     })
                //
                // }
                //
                //
                // // â­ ì¦ê²¨ì°¾ê¸° í•˜íŠ¸ ì¶”ê°€ ì‹œì‘
                // var heart = document.createElement('span');
                //
                // var eventMain = info.el.querySelector('.fc-event-main');
                //
                // heart.style.marginLeft = '8px';
                // heart.style.cursor = 'pointer';
                //
                // console.log(info.event.extendedProps.favorite);
                //
                // if (info.event.extendedProps.favorite) {
                //     heart.innerHTML = 'â¤ï¸';
                //     heart.setAttribute('data-favorited', 'true');
                //
                //     if(eventMain) {
                //         eventMain.style.color='blue';
                //         eventMain.style.fontWeight = 'bold';
                //     }
                //
                //
                // } else {
                //     heart.innerHTML = 'ğŸ¤';
                //     heart.setAttribute('data-favorited', 'false');
                //
                //     if(eventMain) {
                //         eventMain.style.color='black';
                //         eventMain.style.fontWeight = 'normal';
                //     }
                // };
                //
                // heart.addEventListener('click', function (e) {
                //     e.stopPropagation(); // ìƒì„¸ í˜ì´ì§€ ì´ë™ ë§‰ê¸°
                //
                //     var userId = sessionStorage.getItem('userId');
                //     if(userId == null) {
                //         alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤');
                //         return;
                //     }
                //
                //
                //     var isFav = heart.getAttribute('data-favorited') === 'true';
                //     var empSeqNo = Number(info.event.extendedProps.empSeqNo);
                //
                //
                //
                //
                //     if (isFav) {
                //         heart.innerHTML = 'ğŸ¤';
                //         heart.setAttribute('data-favorited', 'false');
                //
                //         if(eventMain) {
                //             eventMain.style.color='black';
                //             eventMain.style.fontWeight = 'normal';
                //         }
                //
                //         var xhr = new XMLHttpRequest();
                //         xhr.open("post", "/mycalendar/favorite/remove", true);
                //         xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                //
                //
                //
                //         xhr.send(JSON.stringify({
                //             empSeqNo: empSeqNo,
                //             userId: sessionStorage.getItem('userId')
                //         }))
                //
                //
                //
                //     } else {
                //         heart.innerHTML = 'â¤ï¸';
                //         heart.setAttribute('data-favorited', 'true');
                //
                //         if(eventMain) {
                //             eventMain.style.color='blue';
                //             eventMain.style.fontWeight = 'bold';
                //         }
                //
                //         var xhr = new XMLHttpRequest();
                //         xhr.open("post", "/mycalendar/favorite/add", true);
                //         xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                //
                //
                //
                //         xhr.send(JSON.stringify({
                //             empSeqNo: empSeqNo,
                //             userId: sessionStorage.getItem('userId')
                //         }))
                //
                //     }
                //
                //     // ì„œë²„ë¡œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ ì €ì¥í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì— Ajax ìš”ì²­ ì‘ì„±
                //
                //
                //     xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                //     xhr.send(JSON.stringify({
                //         id: info.event.id,
                //         favorite: !isFav
                //     }));
                //
                // });
                //
                // var eventMain = info.el.querySelector('.fc-event-main');
                // if (eventMain) {
                //     eventMain.appendChild(heart);
                // }
                // // â­ ì¦ê²¨ì°¾ê¸° í•˜íŠ¸ ì¶”ê°€ ë
                console.log(info.event.extendedProps);

                var mainEl = info.el.querySelector('.fc-event-main');
                if (!mainEl) return;

                mainEl.style.display = 'flex';
                mainEl.style.alignItems = 'center';
                mainEl.style.justifyContent = 'space-between';
                mainEl.style.border = 'none';
                mainEl.style.backgroundColor = '#fff';
                mainEl.style.marginTop = '3px';



                var titleSpan = document.createElement('span');
                titleSpan.textContent = info.event.title;
                titleSpan.style.color = '#000';

                titleSpan.style.flex = '1';
                titleSpan.style.overflow = 'hidden';
                titleSpan.style.textOverflow = 'ellipsis';
                titleSpan.style.whiteSpace = 'nowrap';
                titleSpan.style.minWidth = '0';

                var heart = document.createElement('span');
                heart.style.marginLeft = '8px';
                heart.style.cursor = 'pointer';

                var isFav = info.event.extendedProps.favorite;
                heart.innerHTML = isFav ? 'â¤ï¸' : 'ğŸ¤';
                heart.setAttribute('data-favorited', isFav ? 'true' : 'false');

                heart.addEventListener('click', function (e) {
                    e.stopPropagation();

                    var userId = sessionStorage.getItem('userId');
                    if (!userId) {
                        if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            location.href = '/user/login';
                        }
                        return;
                    }

                    var isNowFav = heart.getAttribute('data-favorited') === 'true';
                    var empSeqNo = Number(info.event.extendedProps.empSeqNo);

                    heart.innerHTML = isNowFav ? 'ğŸ¤' : 'â¤ï¸';
                    heart.setAttribute('data-favorited', (!isNowFav).toString());

                    var xhr = new XMLHttpRequest();
                    xhr.open('post', isNowFav ? '/mycalendar/favorite/remove' : '/mycalendar/favorite/add', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({
                        empSeqNo: empSeqNo,
                        userId: userId
                    }));
                });

                // ë§ˆìš°ìŠ¤ í˜¸ë²„ íˆ´íŒ
                titleSpan.addEventListener('mouseenter', function () {
                    var rect = titleSpan.getBoundingClientRect();

                    tooltip.innerHTML = info.event.title;
                    tooltip.style.position = 'absolute';
                    tooltip.style.setProperty('z-index', '2147483647', 'important');
                    tooltip.style.top = (rect.top + window.scrollY - 150) + 'px';
                    tooltip.style.left = (rect.left + window.scrollX) + 'px';
                    tooltip.style.minWidth = rect.width + 'px';
                    tooltip.style.backgroundColor = 'var(--sub-color2)';
                    tooltip.style.color = '#000';
                    tooltip.style.display = 'block';

                    titleSpan.style.cursor = 'pointer';

                    setTimeout(function () {
                        var popovers = document.querySelectorAll('.fc-popover');
                        for (var i = 0; i < popovers.length; i++) {
                            popovers[i].style.zIndex = '1000';
                        }
                    }, 0);

                });

                titleSpan.addEventListener('mouseleave', function () {
                    tooltip.style.display = 'none';
                });

                titleSpan.addEventListener('click', function () {
                    var homepgDetail = info.event.extendedProps.empWantedHomepgDetail;
                    if (homepgDetail) {
                        window.open(homepgDetail, '_blank');
                    } else {
                        alert('í˜„ì¬ í•´ë‹¹ ê³µê³ ì˜ ìƒì„¸í˜ì´ì§€ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    }
                });

                mainEl.innerHTML = '';

                if (currentEventMode === 'allPosting') {
                    var allWrapper = document.createElement('div');
                    allWrapper.style.display = 'flex';
                    allWrapper.style.alignItems = 'center';
                    allWrapper.style.flex = '1';
                    allWrapper.style.overflow = 'hidden';

                    titleSpan.style.marginLeft = '5px'; // í•˜íŠ¸ì™€ ì œëª© ì‚¬ì´ ì—¬ë°±

                    var bgColor = info.event.extendedProps.color;
                    if(bgColor) {
                        mainEl.style.backgroundColor = bgColor;
                    } else {
                        mainEl.style.backgroundColor = 'rgba(255, 255, 255, 0)';
                    }

                    mainEl.style.borderRadius = "7px";
                    mainEl.style.paddingTop = "3px";
                    mainEl.style.paddingBottom = "3px";

                    allWrapper.appendChild(heart);
                    allWrapper.appendChild(titleSpan);
                    mainEl.appendChild(allWrapper);

                } else {
                    // ì‹œì‘ì¼/ì¢…ë£Œì¼ ëª¨ë“œ
                    var colorDot = document.createElement('span');
                    colorDot.style.display = 'inline-block';
                    colorDot.style.width = '8px';
                    colorDot.style.height = '8px';
                    colorDot.style.borderRadius = '50%';
                    colorDot.style.marginRight = '5px';


                    if (currentEventMode === 'startDay') {
                        colorDot.style.backgroundColor = 'green';
                    } else if (currentEventMode === 'endDay') {

                        colorDot.style.backgroundColor = 'red';
                    }

                    var titleWrapper = document.createElement('div');
                    titleWrapper.style.display = 'flex';
                    titleWrapper.style.alignItems = 'center';
                    titleWrapper.style.flex = '1';
                    titleWrapper.style.overflow = 'hidden';

                    titleWrapper.appendChild(colorDot);
                    titleWrapper.appendChild(titleSpan);

                    mainEl.appendChild(titleWrapper);
                    mainEl.appendChild(heart);
                }
            }

        });

        calendar.render();


    });


    </script>


<script th:src="@{/css/js/header.js}"></script>



<div class="goPostingPageBox">
    <button type="button" id="goPostingPage">ìƒì„¸ê²€ìƒ‰</button>
</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const goPostingPage = document.getElementById('goPostingPage');
        goPostingPage.addEventListener('click', function () {
            event.preventDefault();
            location.href = "/jobposting";
        });
    });

</script>


<div th:replace="~{include/footer :: footerFragment}"></div>

</body>
</html>